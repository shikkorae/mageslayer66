<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–∞–ø—á–∞ 2: –ì–æ–ª–æ—Å–æ–≤–æ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #050505 100%);
            color: #e0e0e0;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .captcha-container {
            background: #121212;
            border: 1px solid #222222;
            border-radius: 16px;
            padding: 30px;
            max-width: 600px;
            width: 100%;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.8);
            text-align: center;
        }
        
        .header {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #222222;
        }
        
        .step-indicator {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .step {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #333;
        }
        
        .step.completed {
            background: #00b894;
        }
        
        .step.active {
            background: #8a2be2;
        }
        
        h1 {
            color: #8a2be2;
            margin-bottom: 10px;
            font-size: 1.8rem;
        }
        
        .instructions {
            margin-bottom: 30px;
            line-height: 1.6;
            color: #a0a0a0;
        }
        
        .phrase-container {
            background: rgba(138, 43, 226, 0.1);
            border: 2px solid #8a2be2;
            border-radius: 12px;
            padding: 25px;
            margin: 25px 0;
            text-align: center;
        }
        
        .phrase {
            font-size: 2.2rem;
            font-weight: bold;
            color: #8a2be2;
            margin: 15px 0;
            line-height: 1.3;
            text-shadow: 0 0 15px rgba(138, 43, 226, 0.5);
            font-family: 'Georgia', serif;
            padding: 15px;
            border-radius: 10px;
            background: rgba(138, 43, 226, 0.05);
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 25px 0;
            flex-wrap: wrap;
        }
        
        .control-btn {
            padding: 14px 28px;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
            min-width: 170px;
            justify-content: center;
        }
        
        .control-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .record-btn {
            background: linear-gradient(135deg, #8a2be2, #5a189a);
            color: white;
        }
        
        .record-btn:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(138, 43, 226, 0.5);
        }
        
        .record-btn.recording {
            background: linear-gradient(135deg, #e17055, #d63031);
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(225, 112, 85, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(225, 112, 85, 0); }
            100% { box-shadow: 0 0 0 0 rgba(225, 112, 85, 0); }
        }
        
        .stop-btn {
            background: linear-gradient(135deg, #333, #222);
            color: white;
            border: 1px solid #444;
        }
        
        .recording-status {
            display: none;
            align-items: center;
            gap: 12px;
            padding: 15px 25px;
            background: linear-gradient(135deg, #e17055, #d63031);
            border-radius: 12px;
            font-weight: 600;
            color: white;
            margin: 20px auto;
            max-width: 300px;
            justify-content: center;
        }
        
        .recording-status.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }
        
        .pulse-dot {
            width: 12px;
            height: 12px;
            background: white;
            border-radius: 50%;
            animation: dotPulse 1s infinite;
        }
        
        @keyframes dotPulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.5); opacity: 0.7; }
        }
        
        .result-container {
            background: rgba(30, 30, 30, 0.8);
            border-radius: 12px;
            padding: 25px;
            margin: 25px 0;
            display: none;
            animation: slideIn 0.5s ease;
        }
        
        .result-container.show {
            display: block;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .result-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .result-icon {
            font-size: 36px;
        }
        
        .result-text {
            font-size: 1.3rem;
            font-weight: 600;
        }
        
        .success {
            color: #00b894;
        }
        
        .error {
            color: #fdcb6e;
        }
        
        .recognized-text {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            font-size: 1.3rem;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            word-break: break-word;
            border: 2px solid #333;
        }
        
        .progress-container {
            margin: 25px 0;
        }
        
        .progress-bar {
            height: 12px;
            background: #333;
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 15px;
            border: 1px solid #444;
        }
        
        .progress-fill {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #e17055, #fdcb6e, #00b894);
            border-radius: 6px;
            transition: width 1s ease;
        }
        
        .progress-labels {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
        }
        
        .progress-label {
            font-size: 0.9rem;
            color: #a0a0a0;
        }
        
        .progress-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #8a2be2;
            font-family: monospace;
        }
        
        .auto-transition {
            margin: 30px 0;
            padding: 25px;
            background: rgba(0, 184, 148, 0.1);
            border-radius: 15px;
            border: 3px solid rgba(0, 184, 148, 0.3);
            display: none;
            animation: fadeIn 0.5s;
        }
        
        .auto-transition.show {
            display: block;
        }
        
        .countdown {
            font-size: 3.5rem;
            font-weight: bold;
            color: #00b894;
            margin: 15px 0;
            font-family: monospace;
            text-shadow: 0 0 20px rgba(0, 184, 148, 0.5);
        }
        
        .transition-text {
            color: #a0a0a0;
            font-size: 1rem;
            line-height: 1.5;
        }
        
        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .action-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .retry-btn {
            background: #333;
            color: #a0a0a0;
            border: 1px solid #444;
        }
        
        .retry-btn:hover {
            background: #444;
            color: #e0e0e0;
        }
        
        .browser-warning {
            color: #fdcb6e;
            background: rgba(253, 203, 110, 0.1);
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            font-size: 0.95rem;
            border: 2px solid rgba(253, 203, 110, 0.3);
            display: none;
            line-height: 1.5;
        }
        
        .browser-warning.show {
            display: block;
            animation: fadeIn 0.5s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .phrase-hint {
            color: #fdcb6e;
            font-size: 0.9rem;
            margin-top: 10px;
            font-style: italic;
        }
        
        .success-animation {
            animation: successPulse 2s infinite;
        }
        
        @keyframes successPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .waiting-message {
            color: #8a2be2;
            margin: 20px 0;
            font-size: 1.1rem;
            padding: 15px;
            background: rgba(138, 43, 226, 0.1);
            border-radius: 10px;
            border: 2px solid rgba(138, 43, 226, 0.3);
        }
    </style>
</head>
<body>
    <div class="captcha-container">
        <div class="header">
            <div class="step-indicator">
                <div class="step completed">1</div>
                <div class="step active">2</div>
                <div class="step">3</div>
            </div>
            <h1>–ì–û–õ–û–°–û–í–û–ï –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–ï</h1>
            <div class="instructions">
                –°–∫–∞–∂–∏—Ç–µ —Ñ—Ä–∞–∑—É –≤ –º–∏–∫—Ä–æ—Ñ–æ–Ω. –ü—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–π–¥–µ–º –¥–∞–ª—å—à–µ.
            </div>
        </div>
        
        <div class="phrase-container">
            <div class="phrase" id="phrase">–Ø –Ω–µ –∑–æ–æ—Ñ–∏–ª, –Ω–æ —è –µ–±–∞–ª –≤—Å–µ—Ö –∫—Ä—ã—Å –∏ –∑–º–µ–π</div>
            <div class="phrase-hint">–ü–û–ô –ù–ê–•–£–ô</div>
        </div>
        
        <div class="waiting-message" id="waitingMessage">
            ‚è≥ –ñ–ú–ê–ô "–ù–ê–ß–ê–¢–¨ –ó–ê–ü–ò–°–¨"
        </div>
        
        <div class="browser-warning" id="browserWarning">
            ‚ö†Ô∏è –î–ª—è —Ä–∞–±–æ—Ç—ã –Ω–µ–æ–±—Ö–æ–¥–∏–º –±—Ä–∞—É–∑–µ—Ä —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Ä–µ—á–∏ (Chrome, Edge).
            –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –º–∏–∫—Ä–æ—Ñ–æ–Ω –ø–æ–¥–∫–ª—é—á–µ–Ω –∏ —Ä–∞–∑—Ä–µ—à–µ–Ω –¥–æ—Å—Ç—É–ø.
        </div>
        
        <div class="controls">
            <button class="control-btn record-btn" id="startBtn">
                <span>üé§</span> –ù–ê–ß–ê–¢–¨ –ó–ê–ü–ò–°–¨
            </button>
            <button class="control-btn stop-btn" id="stopBtn" disabled>
                <span>‚èπÔ∏è</span> –û–°–¢–ê–ù–û–í–ò–¢–¨
            </button>
        </div>
        
        <div class="recording-status" id="recordingStatus">
            <div class="pulse-dot"></div>
            –ò–î–Å–¢ –ó–ê–ü–ò–°–¨ –ï–ë–ê–ù–ê
        </div>
        
        <div class="result-container" id="resultContainer">
            <div class="result-header">
                <div class="result-icon" id="resultIcon">üéØ</div>
                <div class="result-text" id="resultText">–ê–ù–ê–õ–ò–ó –†–ï–ó–£–õ–¨–¢–ê–¢–ê</div>
            </div>
            
            <div class="recognized-text" id="recognizedText">
                –†–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å...
            </div>
            
            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-labels">
                    <div class="progress-label">–¢–û–ß–ù–û–°–¢–¨ –†–ê–°–ü–û–ó–ù–ê–í–ê–ù–ò–Ø</div>
                    <div class="progress-value" id="confidenceValue">0%</div>
                </div>
            </div>
            
            <div class="action-buttons">
                <button class="action-btn retry-btn" onclick="retryRecording()">
                    <span>üîÑ</span> –ü–û–ü–†–û–ë–û–í–ê–¢–¨ –ï–©–ï –†–ê–ó
                </button>
            </div>
        </div>
        
        <div class="auto-transition" id="autoTransition">
            <div class="countdown" id="countdown">4</div>
            <div class="transition-text">
                ‚úÖ –í–ê–¢–ê–§–ê<br>
                –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ—Ö–æ–¥ —á–µ—Ä–µ–∑ <span id="secondsLeft">4</span> —Å–µ–∫—É–Ω–¥—ã
            </div>
        </div>
    </div>

    <script>
        // ========== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ==========
        const CONFIG = {
            targetPhrase: '–Ø –Ω–µ –∑–æ–æ—Ñ–∏–ª –Ω–æ —è –µ–±–∞–ª –≤—Å–µ—Ö –∫—Ä—ã—Å –∏ –∑–º–µ–π',
            successThreshold: 70, // 70% –¥–ª—è —É—Å–ø–µ—Ö–∞ (–µ—â–µ –Ω–∏–∂–µ –ø–æ—Ä–æ–≥)
            transitionTime: 4,    // 4 —Å–µ–∫—É–Ω–¥—ã –¥–æ –ø–µ—Ä–µ—Ö–æ–¥–∞
            strictMode: false     // –†–µ–∂–∏–º —Å—Ç—Ä–æ–≥–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏
        };
        
        // ========== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ==========
        let SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition = null;
        let isRecording = false;
        let transitionTimer = null;
        let countdownValue = CONFIG.transitionTime;
        let sessionId = Date.now(); // –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID —Å–µ—Å—Å–∏–∏
        
        // ========== DOM –≠–õ–ï–ú–ï–ù–¢–´ ==========
        const elements = {
            startBtn: document.getElementById('startBtn'),
            stopBtn: document.getElementById('stopBtn'),
            recordingStatus: document.getElementById('recordingStatus'),
            resultContainer: document.getElementById('resultContainer'),
            recognizedText: document.getElementById('recognizedText'),
            resultIcon: document.getElementById('resultIcon'),
            resultText: document.getElementById('resultText'),
            progressFill: document.getElementById('progressFill'),
            confidenceValue: document.getElementById('confidenceValue'),
            autoTransition: document.getElementById('autoTransition'),
            countdown: document.getElementById('countdown'),
            secondsLeft: document.getElementById('secondsLeft'),
            browserWarning: document.getElementById('browserWarning'),
            phrase: document.getElementById('phrase'),
            waitingMessage: document.getElementById('waitingMessage')
        };
        
        // ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ==========
        function init() {
            console.log(`[VoiceCaptcha ${sessionId}] –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...`);
            
            // –û–ß–ò–°–¢–ö–ê –ü–†–ï–î–´–î–£–©–ò–• –î–ê–ù–ù–´–•
            // –£–¥–∞–ª—è–µ–º –¢–û–õ–¨–ö–û –¥–∞–Ω–Ω—ã–µ —ç—Ç–æ–π –∫–∞–ø—á–∏, –Ω–æ –æ—Å—Ç–∞–≤–ª—è–µ–º –¥—Ä—É–≥–∏–µ
            localStorage.removeItem('captcha2Success');
            localStorage.removeItem('captcha2Phrase');
            localStorage.removeItem('captcha2Score');
            
            // –ù–ò–ö–û–ì–î–ê –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            // –í—Å–µ–≥–¥–∞ –Ω–∞—á–∏–Ω–∞–µ–º —Å —á–∏—Å—Ç–æ–≥–æ –ª–∏—Å—Ç–∞
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É –±—Ä–∞—É–∑–µ—Ä–∞
            const isSupported = checkBrowserSupport();
            
            if (isSupported) {
                initRecognition();
                
                // –í–°–ï–ì–î–ê –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –∑–∞–ø–∏—Å–∏
                elements.waitingMessage.style.display = 'block';
            }
            
            // –ù–∞–∑–Ω–∞—á–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
            elements.startBtn.addEventListener('click', startRecording);
            elements.stopBtn.addEventListener('click', stopRecording);
            
            // –ê–Ω–∏–º–∞—Ü–∏—è —Ñ—Ä–∞–∑—ã
            animatePhrase();
            
            console.log(`[VoiceCaptcha ${sessionId}] –ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ`);
        }
        
        // ========== –ü–†–û–í–ï–†–ö–ê –ü–û–î–î–ï–†–ñ–ö–ò –ë–†–ê–£–ó–ï–†–ê ==========
        function checkBrowserSupport() {
            if (!SpeechRecognition) {
                elements.browserWarning.classList.add('show');
                elements.startBtn.disabled = true;
                elements.startBtn.innerHTML = '<span>üö´</span> –ù–ï –ü–û–î–î–ï–†–ñ–ò–í–ê–ï–¢–°–Ø';
                console.warn(`[VoiceCaptcha ${sessionId}] –ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç SpeechRecognition API`);
                return false;
            }
            
            console.log(`[VoiceCaptcha ${sessionId}] –ë—Ä–∞—É–∑–µ—Ä –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç SpeechRecognition API`);
            return true;
        }
        
        // ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –†–ê–°–ü–û–ó–ù–ê–í–ê–ù–ò–Ø ==========
        function initRecognition() {
            try {
                recognition = new SpeechRecognition();
                recognition.lang = 'ru-RU';
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.maxAlternatives = 3;
                
                console.log(`[VoiceCaptcha ${sessionId}] –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ`);
                
                recognition.onstart = function() {
                    isRecording = true;
                    elements.recordingStatus.classList.add('active');
                    elements.startBtn.disabled = true;
                    elements.startBtn.classList.add('recording');
                    elements.stopBtn.disabled = false;
                    elements.waitingMessage.style.display = 'none';
                    console.log(`[VoiceCaptcha ${sessionId}] –ó–∞–ø–∏—Å—å –Ω–∞—á–∞—Ç–∞`);
                };
                
                recognition.onresult = function(event) {
                    const result = event.results[0];
                    const bestAlternative = result[0];
                    const transcript = bestAlternative.transcript.toLowerCase().trim();
                    const confidence = bestAlternative.confidence;
                    
                    console.log(`[VoiceCaptcha ${sessionId}] –†–∞—Å–ø–æ–∑–Ω–∞–Ω–æ: "${transcript}" (—É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: ${confidence.toFixed(2)})`);
                    
                    processResult(transcript, confidence);
                };
                
                recognition.onerror = function(event) {
                    console.error(`[VoiceCaptcha ${sessionId}] –û—à–∏–±–∫–∞: ${event.error}`);
                    
                    let errorMessage = '–û—à–∏–±–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è';
                    switch (event.error) {
                        case 'no-speech':
                            errorMessage = '–†–µ—á—å –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≥–æ–≤–æ—Ä–∏—Ç—å –≥—Ä–æ–º—á–µ.';
                            break;
                        case 'audio-capture':
                            errorMessage = '–ú–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞.';
                            break;
                        case 'not-allowed':
                            errorMessage = '–î–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –∑–∞–ø—Ä–µ—â–µ–Ω. –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞.';
                            break;
                        case 'network':
                            errorMessage = '–ü—Ä–æ–±–ª–µ–º—ã —Å —Å–µ—Ç—å—é. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.';
                            break;
                        default:
                            errorMessage = `–û—à–∏–±–∫–∞: ${event.error}`;
                    }
                    
                    showError(errorMessage);
                    stopRecording();
                };
                
                recognition.onend = function() {
                    console.log(`[VoiceCaptcha ${sessionId}] –ó–∞–ø–∏—Å—å –∑–∞–≤–µ—Ä—à–µ–Ω–∞`);
                    stopRecording();
                };
                
            } catch (error) {
                console.error(`[VoiceCaptcha ${sessionId}] –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:`, error);
                showError('–ù–µ —É–¥–∞–ª–æ—Å—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏');
            }
        }
        
        // ========== –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò ==========
        
        function startRecording() {
            if (!recognition || isRecording) return;
            
            console.log(`[VoiceCaptcha ${sessionId}] –ó–∞–ø—É—Å–∫ –∑–∞–ø–∏—Å–∏...`);
            resetResults();
            
            try {
                recognition.start();
            } catch (error) {
                console.error(`[VoiceCaptcha ${sessionId}] –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞:`, error);
                showError('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –∑–∞–ø–∏—Å—å. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.');
            }
        }
        
        function stopRecording() {
            if (recognition && isRecording) {
                try {
                    recognition.stop();
                } catch (e) {
                    // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ
                }
            }
            
            isRecording = false;
            elements.recordingStatus.classList.remove('active');
            elements.startBtn.disabled = false;
            elements.startBtn.classList.remove('recording');
            elements.stopBtn.disabled = true;
        }
        
        function processResult(transcript, confidence) {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            elements.resultContainer.classList.add('show');
            elements.recognizedText.textContent = `"${transcript}"`;
            
            // –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Å—Ö–æ–¥—Å—Ç–≤–æ
            const analysis = analyzeSimilarity(transcript, CONFIG.targetPhrase);
            const confidencePercent = Math.round(confidence * 100);
            const similarityPercent = Math.round(analysis.similarity * 100);
            
            // –í–∑–≤–µ—à–µ–Ω–Ω–∞—è –æ—Ü–µ–Ω–∫–∞
            const finalScore = Math.round((confidencePercent * 0.6) + (similarityPercent * 0.4));
            
            console.log(`[VoiceCaptcha ${sessionId}] –ê–Ω–∞–ª–∏–∑:
                –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å API: ${confidencePercent}%
                –°—Ö–æ–¥—Å—Ç–≤–æ: ${similarityPercent}%
                –ò—Ç–æ–≥: ${finalScore}%
                –ü–æ—Ä–æ–≥: ${CONFIG.successThreshold}%`);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é
            elements.progressFill.style.width = finalScore + '%';
            elements.confidenceValue.textContent = finalScore + '%';
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ø–µ—Ö
            if (finalScore >= CONFIG.successThreshold) {
                handleSuccess(transcript, finalScore);
            } else {
                handleFailure(transcript, finalScore);
            }
        }
        
        function analyzeSimilarity(recognized, target) {
            const recognizedWords = recognized.toLowerCase().split(/\s+/);
            const targetWords = target.toLowerCase().split(/\s+/);
            
            let matchedWords = 0;
            let totalScore = 0;
            
            // –£–ü–†–û–©–ï–ù–ù–ê–Ø –õ–û–ì–ò–ö–ê - —Ç–æ–ª—å–∫–æ –æ—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏
            targetWords.forEach((targetWord, index) => {
                let bestScore = 0;
                
                // –ò—â–µ–º –ª—É—á—à–µ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
                recognizedWords.forEach(recognizedWord => {
                    let score = 0;
                    
                    // –ü–æ–ª–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
                    if (recognizedWord === targetWord) {
                        score = 1.0;
                    }
                    // –ß–∞—Å—Ç–∏—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
                    else if (recognizedWord.includes(targetWord) || targetWord.includes(recognizedWord)) {
                        score = 0.8;
                    }
                    // –ü–æ—Ö–æ–∂–∏–µ —Å–ª–æ–≤–∞ (–ø–µ—Ä–≤—ã–µ 3 –±—É–∫–≤—ã)
                    else if (recognizedWord.slice(0, 3) === targetWord.slice(0, 3)) {
                        score = 0.6;
                    }
                    // –ü–æ—Ö–æ–∂–∏–µ —Å–ª–æ–≤–∞ (–ø–µ—Ä–≤—ã–µ 2 –±—É–∫–≤—ã)
                    else if (recognizedWord.slice(0, 2) === targetWord.slice(0, 2)) {
                        score = 0.4;
                    }
                    
                    if (score > bestScore) {
                        bestScore = score;
                    }
                });
                
                if (bestScore >= 0.6) {
                    matchedWords++;
                }
                
                totalScore += bestScore;
            });
            
            // –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –æ—Ü–µ–Ω–∫–∞
            const wordScore = matchedWords / targetWords.length;
            const similarityScore = totalScore / targetWords.length;
            const finalSimilarity = (wordScore * 0.7) + (similarityScore * 0.3);
            
            return {
                similarity: finalSimilarity,
                matchedWords: matchedWords,
                totalWords: targetWords.length
            };
        }
        
        function handleSuccess(transcript, score) {
            console.log(`[VoiceCaptcha ${sessionId}] –£–°–ü–ï–•! –û—Ü–µ–Ω–∫–∞: ${score}%`);
            
            // –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—Ö–∞
            elements.resultIcon.textContent = '‚úÖ';
            elements.resultIcon.style.color = '#00b894';
            elements.resultText.textContent = '–§–û –í–û–¢–û–§–û';
            elements.resultText.className = 'result-text success';
            elements.resultContainer.classList.add('success-animation');
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —É—Å–ø–µ—Ö –¢–û–õ–¨–ö–û –¥–ª—è —ç—Ç–æ–π —Å–µ—Å—Å–∏–∏
            sessionStorage.setItem('captcha2Success', 'true');
            sessionStorage.setItem('captcha2Phrase', transcript);
            sessionStorage.setItem('captcha2Score', score);
            sessionStorage.setItem('captcha2Session', sessionId);
            
            // –ù–∞—á–∏–Ω–∞–µ–º –æ–±—Ä–∞—Ç–Ω—ã–π –æ—Ç—Å—á–µ—Ç
            startCountdown();
        }
        
        function handleFailure(transcript, score) {
            console.log(`[VoiceCaptcha ${sessionId}] –ê–ù–õ–ê–ö–ò –û—Ü–µ–Ω–∫–∞: ${score}%`);
            
            // –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –Ω–µ—É–¥–∞—á–∏
            elements.resultIcon.textContent = '‚ùå';
            elements.resultIcon.style.color = '#fdcb6e';
            elements.resultText.textContent = '–ß–ï–¢–ß–ï –°–£–ö–ê';
            elements.resultText.className = 'result-text error';
            elements.resultContainer.classList.remove('success-animation');
            
            // –°–æ–≤–µ—Ç –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è
            if (score >= 60 && score < CONFIG.successThreshold) {
                elements.recognizedText.innerHTML = `"${transcript}"<br><small style="color: #fdcb6e;">–ü–æ—á—Ç–∏ –ø–æ–ª—É—á–∏–ª–æ—Å—å! –°–∫–∞–∂–∏—Ç–µ —á–µ—Ç—á–µ: "–Ø –Ω–µ –∑–æ–æ—Ñ–∏–ª –Ω–æ —è –µ–±–∞–ª –≤—Å–µ—Ö –∫—Ä—ã—Å –∏ –∑–º–µ–π"</small>`;
            }
        }
        
        function startCountdown() {
            countdownValue = CONFIG.transitionTime;
            elements.autoTransition.classList.add('show');
            elements.countdown.textContent = countdownValue;
            elements.secondsLeft.textContent = countdownValue;
            
            // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏
            elements.startBtn.disabled = true;
            elements.stopBtn.disabled = true;
            
            console.log(`[VoiceCaptcha ${sessionId}] –û–±—Ä–∞—Ç–Ω—ã–π –æ—Ç—Å—á–µ—Ç: ${countdownValue} —Å–µ–∫—É–Ω–¥`);
            
            transitionTimer = setInterval(() => {
                countdownValue--;
                elements.countdown.textContent = countdownValue;
                elements.secondsLeft.textContent = countdownValue;
                
                if (countdownValue <= 0) {
                    clearInterval(transitionTimer);
                    completeTransition();
                }
            }, 1000);
        }
        
        function completeTransition() {
            console.log(`[VoiceCaptcha ${sessionId}] –ù–ï–ö–°–¢...`);
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
            localStorage.setItem('captcha2Passed', 'true');
            
            // –ü–µ—Ä–µ—Ö–æ–¥ —Å –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏
            setTimeout(() => {
                window.location.href = 'captcha3.html';
            }, 500);
        }
        
        function resetResults() {
            elements.resultContainer.classList.remove('show');
            elements.autoTransition.classList.remove('show');
            elements.progressFill.style.width = '0%';
            elements.confidenceValue.textContent = '0%';
            elements.resultContainer.classList.remove('success-animation');
            elements.waitingMessage.style.display = 'none';
            
            if (transitionTimer) {
                clearInterval(transitionTimer);
                transitionTimer = null;
            }
            
            // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏
            elements.startBtn.disabled = false;
        }
        
        function showError(message) {
            elements.resultContainer.classList.add('show');
            elements.resultIcon.textContent = '‚ö†Ô∏è';
            elements.resultIcon.style.color = '#fdcb6e';
            elements.resultText.textContent = message;
            elements.resultText.className = 'result-text error';
            elements.recognizedText.textContent = '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö';
            elements.progressFill.style.width = '0%';
            elements.confidenceValue.textContent = '0%';
        }
        
        function retryRecording() {
            console.log(`[VoiceCaptcha ${sessionId}] –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞`);
            resetResults();
        }
        
        function animatePhrase() {
            let counter = 0;
            setInterval(() => {
                counter++;
                const hue = (counter * 30) % 360;
                elements.phrase.style.color = `hsl(${hue}, 70%, 65%)`;
                elements.phrase.style.textShadow = `0 0 25px hsla(${hue}, 70%, 65%, 0.5)`;
            }, 1000);
        }
        
        // ========== –ó–ê–ü–£–°–ö ==========
        document.addEventListener('DOMContentLoaded', init);
        
        // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫
        window.retryRecording = retryRecording;
    </script>
</body>
</html>